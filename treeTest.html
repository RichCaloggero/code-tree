<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Test</title>

<style>
.fold-trigger, .block, .block .fold-marker, .block .content {display: inline;}
.block .hidden {display: none;}
#codeTree, #debug, .editor .content {white-space: pre;}
</style>

<script src="http://code.jquery.com/jquery.min.js"></script>
<script src="esprima.js"></script>
<script src="debug.js"></script>
<script src="toHtml.js"></script>
<script src="treeWalker.js"></script>
</head>
<body>
<h1>Test</h1>

<div id="codeTree" role="region" aria-label="Code Tree">
</div>

<div class="editor js">
<button class="edit" aria-pressed="true">Edit</button>
<textarea class="content" readonly="true" cols="80" rows="25">
</textarea>
</div>

<div id="debug" role="region" aria-label="debug" aria-live="polite">
</div>

<script>
jQuery.get ("t.txt", null, null, "text")
.fail (function (error) {
alert (error);

}).done (function (text) {
$(".editor .content").val (text);
displayTree ( $("#codeTree") );
}); // get

$(".editor").on ("change", ".content", function () {
displayTree ( $("#codeTree") );
}); // update on change

function displayTree ($folded) {
var parseTree, html;
var text = $(".editor .content").val ();
parseTree = esprima.parse (text);
debug (
JSON.stringify(parseTree)
.replace (/\:\[/g, ": [\n")
.replace (/\:\{/g, ": {\n")
.replace (/\],/g, "],\n")
.replace (/\},/g, "},\n")
); // debug

html = toHtml(parseTree);

$folded.html (html);
foldAll ($folded);


// toggle fold status

makeAccessible ({
$container: $folded.find (".block:first"),
name: "treeTest",

ul: ".block", 
li: ".item",

open : function ($node) {
debug ("myOpen: " + $node[0].className);
unfold ($node.find(".block:first"));
}, // open

close : function ($node) {
debug ("myClose: " + $node[0].className);
fold ($node.find (".block:first"));
}, // close

currentNode : function ($node) {
}, // open

leaveNode : function ($node) {
}, // close
}); // makeAccessible


/*$folded.on ("click", ".fold-trigger", function (e) {
//toggleFold ($(e.target));
e.stopPropagation ();
e.stopImmediatePropagation ();
e.preventDefault ();
return false;

}).on ("keydown", ".fold-trigger", function (e) {
var key = e.keyCode;

if (key === 13 || key === 32) {
$(e.target).trigger ("click");
return false;
} // if

return true;
}); // click
*/

function unfoldAll ($tree) {
var $blocks = $tree.find (".fold-trigger .block");
$blocks.find (".content").removeClass ("hidden");
$blocks.find (".fold-marker").addClass ("hidden");
} // unfoldAll

function foldAll ($tree) {
var $blocks = $tree.find (".fold-trigger .block");
$blocks.find (".content").addClass ("hidden");
$blocks.find (".fold-marker").removeClass ("hidden");
} // foldAll

function unfold ($block) {
debug ("unfolding... ");
$block.find (".content").removeClass ("hidden");
$block.find (".fold-marker").addClass ("hidden");
} // unfold

function fold ($block) {
debug ("folding... ");
$block.find (".content").addClass ("hidden");
$block.find (".fold-marker").removeClass ("hidden");
} // fold

function toggleFold ($block) {
var $content = $(".content", $block).first();
var $marker = $content.next(".fold-marker");

//debug (`${$marker.length} ${$content.length}`);

$marker.toggleClass ("hidden");
$content.toggleClass ("hidden");
$block.parent().find(".fold-trigger").attr (
"aria-expanded", $content.hasClass("hidden")? "false" : "true"
);
//$(".editor .content").val ($folded.html());
return false;
} // toggleFold
} // displayTree




$(".editor > .edit").on ("click", function (e) {
var $edit = $(e.target);
var state = $edit.attr("aria-pressed") === "true";
var $editor = $edit.parent();
if (! $editor || $editor.length === 0) return;

if (state) {
// turn it off
disableEditor ($editor);
$(this).attr ("aria-pressed", "false");

} else {
// turn it on
enableEditor ($editor);
$(this).attr ("aria-pressed", "true");
} // if

}).on ("keydown", "button,a", function (e) {
$(e.target).trigger ("click");
}); // click .edit

function enableEditor ($editor) {
$(".content", $editor).removeAttr ("readonly")
.focus();
} // enableEditor

function disableEditor ($editor) {
$(".content", $editor).attr ("readonly", "true");
} // disableEditor


</script>

</body>
</html>
